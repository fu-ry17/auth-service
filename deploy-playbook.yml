---
- hosts: dev
  become: true
  vars:
    workspace_dir: "{{ workspace_dir }}"
    remote_workspace: "/opt/jenkins/workspace/auth-service"
    docker_registry: "{{ docker_registry }}"
    helm_repo: "{{ helm_repo }}"
    k8s_env: "{{ k8s_env }}"
    branch_name: "{{ branch_name }}"

  tasks:
    - name: Create and sync workspace
      block:
        - name: Create remote workspace directory
          file:
            path: "{{ remote_workspace }}"
            state: directory
            mode: '0755'
            owner: ubuntu
            group: ubuntu

        - name: Synchronize workspace
          synchronize:
            src: "{{ workspace_dir }}/"
            dest: "{{ remote_workspace }}"
            rsync_opts:
              - "--exclude=.git"
          become: no

    - name: Run unit tests
      shell: |
        chmod +x gradlew
        ./gradlew clean test --build-cache
      args:
        chdir: "{{ remote_workspace }}"
      register: test_result
      failed_when: test_result.rc != 0

    - name: Set version and image info
      block:
        - name: Get application version
          shell: |
            ./gradlew properties -q | grep '^version:' | grep -v 'kotlin.version:' | awk '{print $2}'
          args:
            chdir: "{{ remote_workspace }}"
          register: version_result

        - name: Get chart name
          shell: |
            docker run -v {{ remote_workspace }}:/app -w /app dtzar/helm-kubectl helm show chart ./charts | grep name | cut -d: -f 2 | tr -d ' '
          register: chart_name_result

        - name: Set image facts
          set_fact:
            app_version: "{{ version_result.stdout | trim }}"
            app_name: "{{ chart_name_result.stdout | trim }}-{{ k8s_env }}"
            chart_name: "{{ chart_name_result.stdout | trim }}"

    - name: Build and push Docker image
      block:
        - name: Login to Docker registry
          shell: |
            docker login {{ docker_registry }} -u {{ docker_user }} -p {{ docker_pass }}
          no_log: true

        - name: Build and push Docker images
          shell: |
            docker build \
              -t {{ docker_registry }}/{{ app_name }}:{{ app_version }} \
              -t {{ docker_registry }}/{{ app_name }}:latest \
              {{ remote_workspace }} && \
            docker push {{ docker_registry }}/{{ app_name }}:{{ app_version }} && \
            docker push {{ docker_registry }}/{{ app_name }}:latest

    - name: Package and push Helm chart
      block:
        - name: Package and push Helm chart
          shell: |
            docker run --rm \
              -v {{ remote_workspace }}:/app \
              -w /app \
              dtzar/helm-kubectl \
              helm package charts/ --app-version {{ app_version }} --version {{ app_version }} && \
            curl -u {{ docker_user }}:{{ docker_pass }} {{ helm_repo }} --upload-file {{ chart_name }}-{{ app_version }}.tgz -v
          args:
            chdir: "{{ remote_workspace }}"

    - name: Deploy to dev environment
      when: k8s_env == 'dev'
      block:
        - name: Execute dev deployment
          shell: |
            timeout 300 ssh -o ConnectTimeout=10 -o BatchMode=yes ubuntu@10.0.3.252 "
              set -e
              echo 'Starting deployment...'
              cd /home/ubuntu/agencify-backend || exit 1
              echo 'Fetching latest changes...'
              git fetch
              echo 'Checking out branch {{ branch_name | default('develop') }}...'
              git checkout {{ branch_name | default('develop') }}
              echo 'Pulling latest changes...'
              git pull origin {{ branch_name | default('develop') }} --rebase
              echo 'Starting docker compose...'
              sudo docker compose up -d
              echo 'Deployment completed'
            "
          register: deploy_result
          ignore_errors: yes
          async: 300  # 5 minutes timeout
          poll: 10    # Check every 10 seconds

        - name: Show deployment error
          when: deploy_result.rc != 0 or deploy_result.failed is defined
          debug:
            msg: |
              Deployment failed with error:
              Return code: {{ deploy_result.rc | default('N/A') }}
              Error message: {{ deploy_result.stderr | default('No error message') }}
              Output: {{ deploy_result.stdout | default('No output') }}
          failed_when: true

        - name: Show deployment success
          when: deploy_result.rc == 0 and deploy_result.failed is not defined
          debug:
            msg: "Deployment completed successfully: {{ deploy_result.stdout }}"

          